---
- name: Make sure keyring dir exists
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
- name: Get openbytes apt key
  ansible.builtin.get_url:
    url: https://repo.openbytes.ie/openbytes.gpg
    dest: /etc/apt/keyrings/openbytes.gpg
- name: Add openbytes repo
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/openbytes.gpg] https://repo.openbytes.ie/patchman/debian bookworm main"
  notify:
    - Update apt cache
- name: Install PatchMan client
  ansible.builtin.apt:
    name: patchman-client
- name: Create patchman client config
  ansible.builtin.template:
    src: patchman.conf.j2
    dest: /etc/patchman/patchman-client.conf
- name: Add patchman as a cronjob
  ansible.builtin.cron:
    name: "hourly run of patchman"
    user: "root"
    minute: "0"
    hour: "1"
    job: "/usr/sbin/patchman-client"
- name: Initial run of patchman-client
  ansible.builtin.command:
    cmd: /usr/sbin/patchman-client
