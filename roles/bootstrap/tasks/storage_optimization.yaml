---
- name: Install mdadm package
  ansible.builtin.package:
    name: mdadm
    state: present
- name: Get unused disk devices
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      lsblk -rno NAME,TYPE | awk '$2=="disk" {print $1}' | while read disk; do
        has_mounted=$(lsblk -rno NAME,MOUNTPOINT /dev/$disk | awk 'NR>1 && $2!="" {print "yes"}')
        has_partitions=$(lsblk -rno NAME,TYPE /dev/$disk | awk 'NR>1 && $2=="part" {print "yes"}')
        if [ -z "$has_mounted" ] && [ -z "$has_partitions" ]; then
          echo "/dev/$disk"
        fi
      done | head -2
    executable: /bin/bash
  register: bootstrap_unused_disks
  changed_when: false
- name: Fail if less than 2 unused disks are found
  ansible.builtin.fail:
    msg: >-
      Storage optimization requires exactly 2 unused disks,
      but found {{ bootstrap_unused_disks.stdout_lines | length }}
  when: bootstrap_unused_disks.stdout_lines | length != 2
- name: Check if RAID array already exists
  ansible.builtin.stat:
    path: /dev/md0
  register: bootstrap_raid_device
- name: Create RAID0 array from unused disks
  ansible.builtin.command:
    cmd: "mdadm --create /dev/md0 --level=0 --raid-devices=2 {{ bootstrap_unused_disks.stdout_lines | join(' ') }}"
  when: not bootstrap_raid_device.stat.exists
- name: Wait for RAID array to be ready
  ansible.builtin.wait_for:
    path: /dev/md0
    timeout: 60
  when: not bootstrap_raid_device.stat.exists
- name: Check if RAID array is already formatted
  ansible.builtin.command:
    cmd: blkid /dev/md0
  register: bootstrap_raid_format_check
  failed_when: false
  changed_when: false
- name: Format RAID array with ext4
  community.general.filesystem:
    fstype: ext4
    dev: /dev/md0
  when: bootstrap_raid_format_check.rc != 0
- name: Create /data mount point
  ansible.builtin.file:
    path: /data
    state: directory
    mode: '0755'
- name: Get UUID of RAID device
  ansible.builtin.command:
    cmd: blkid -s UUID -o value /dev/md0
  register: bootstrap_raid_uuid
  changed_when: false
- name: Mount RAID array at /data
  ansible.posix.mount:
    path: /data
    src: "UUID={{ bootstrap_raid_uuid.stdout }}"
    fstype: ext4
    opts: defaults,noatime
    state: mounted
- name: Save mdadm configuration
  ansible.builtin.shell:
    cmd: mdadm --detail --scan >> /etc/mdadm/mdadm.conf
    creates: /etc/mdadm/mdadm.conf
